# Домашняя работа №4. Graphite

В этом домашнем задании речь пойдёт про систему мониторинга Graphite.

### TimeSeries
Чтобы в дальнейшем говорить о Graphite и такой модели данных как TimeSeries, нужно начать с определений. Что же такое временной ряд?

Временным рядом называется последовательность упорядоченных во времени наблюдений некоторой величины. Временные ряды - один из наиболее часто исследуемых объектов при изучении социально-экономических процессов и явлений, так как экономические данные чаще всего бывают представлены в виде временного ряда. В качестве примера временных рядов можно назвать данные о ежедневных котировках акций на фондовой бирже и данные о среднемесячных доходах в регионе за несколько лет.

Анализируя временные ряды, можно построить математическую модель ряда, выявить закономерности его поведения в прошлом и на основе этого сделать прогноз поведения экономического показателя в будущем.

### История развития Graphite
В 1995 году швейцарец Тобиас Этикер в поисках способа отслеживания сетевой активности разработал небольшой Perl-скрипт для мониторинга уровня трафика на сетевом маршрутизаторе. Запрашивая статистику каждые пять минут, он использовал эти данные для создания серии графиков, детализирующих текущее и прошлое состояния сети. Полученные данные записывались в RRD - циклическую БД. Данный инструмент стал известен как Multi Router Traffic Grapher (MRTG). 

Graphite же был разработан Крисом Дэвисом в туристическом онлайн-агентстве Orbitz в 2006 году как сторонний проект, который в конечном итоге стал основным инструментом мониторинга в компании. В 2008 году Orbitz разрешила выпуск Graphite под лицензией Apache 2.0 с открытым исходным кодом. Сейчас Graphite используется во многих крупных компаниях, например, в Reddit, Booking.com и Github.

Итак, Graphite - это инструмент мониторинга. Компании используют Graphite для отслеживания производительности своих веб-сайтов, приложений, бизнес-сервисов и сетевых серверов. Graphite положил начало новому поколению инструментов мониторинга, упростив, как никогда, хранение, извлечение, совместное использование и визуализацию данных временных рядов. 


Graphite имеет три компонента - [Carbon](https://github.com/graphite-project/carbon), [Whisper](https://github.com/graphite-project/whisper) и [Graphite-Web](https://github.com/graphite-project/graphite-web). Carbon получает данные временных рядов, агрегирует их и сохраняет на диске. Graphite-Web - это интерфейс для создания панелей мониторинга и визуализации данных. Whisper - это файловая БД для хранения временных рядов. Метрики хранятся в отдельных файлах – по файлу на метрику, что позволяет довольно удобно этими метриками управлять. Whisper также исправлял некоторую ошибку в RRD. Раньше RRD не могла принимать данные вне последовательности. То есть если метрика A с отметкой времени 09:05:00 поступала после метрики B с отметкой времени 09:05:30, А отбрасывалась RRD. Whisper устранил этот недостаток и в то же время значительно упростил конфигурацию и расположение временных рядов в каждом файле базы данных.

Формат хранения данных в хранилище: `<metric-path> <value> <timestamp>`.

### Инструменты для взаимодействия с СУБД
Посылать метрики можно по HTTP. Наблюдать их на графике можно через веб-интерфейс Graphite-Web или через Grafana. [Здесь](https://graphite.readthedocs.io/en/latest/feeding-carbon.html) можно подробнее прочитать про формат сообщения.

### Database engine
Whisper

### Как устроен язык запросов в вашей СУБД? Разверните БД с данными и выполните ряд запросов.
Для развёртывания есть специальный инструмент - Synthesize. Но легче всего развернуть БД в докере, что я и сделала:
```bash
docker run -d \
 --name graphite \
 --restart=always \
 -p 80:80 \
 -p 2003-2004:2003-2004 \
 -p 2023-2024:2023-2024 \
 -p 8125:8125/udp \
 -p 8126:8126 \
 graphiteapp/graphite-statsd
```

После этого можно зайти на `http://localhost:80/` и увидеть страничку с веб-приложения. Можно зайти в админку с логином и паролем "root" - их можно переопределить.

![Screenshot from 2022-05-05 16-41-25](https://user-images.githubusercontent.com/60742399/166936374-3459187f-1f54-45fe-b0fb-11bd84e61612.png)

Чтобы отправить метрику вручную, выполните `echo "<название метрики> <метрика> `date +%s`" | nc -q0 localhost 2003`. После этого добавится точка на соответствующем графике. Чтобы её было видно, настройте время наблюдения, чтобы шкала была достаточно мелкой:

![Screenshot from 2022-05-05 16-46-43](https://user-images.githubusercontent.com/60742399/166937480-977db057-0837-4c28-8428-e5c083659991.png)

Если несколько раз отправим метрику `foo.bar` со значением 1, то на графике увидим

![Screenshot from 2022-05-05 16-50-49](https://user-images.githubusercontent.com/60742399/166938174-a200b94d-61fd-47a3-b621-e3378c2c23ee.png)

Считать отправленную метрику можно также по HTTP, например, выполнив код на Python
```python
import requests

if __name__ == '__main__':
    ans = requests.get('http://localhost:80/render/', params={'format':'json', 'target':'foo.bar', 'from':'1651758792'})
    print(ans.json())

```

Параметр from отвечает за отметку времени, начиная с которой мы считываем метрики. Чтобы в ответе не было очень много None'ов, смотрим на текущую отметку времени, отправляем после этого метрику и смотрим на результат

![Screenshot from 2022-05-05 16-55-35](https://user-images.githubusercontent.com/60742399/166940969-adf8129e-9197-4360-9c84-861663f1e153.png)

Наш запрос вернёт 

```
[{'target': 'foo.bar', 'tags': {'name': 'foo.bar'}, 'datapoints': [[None, 1651758800], [None, 1651758810]]}]
```

### Распределение файлов БД по разным носителям

Кластеризация поддерживается. [Утилита для создания кластера](https://github.com/graphite-project/carbonate).

### На каком языке/ах программирования написана СУБД?
Whisper и Carbon полностью написаны на Python, Graphite-Web - на JS.

### Какие типы индексов поддерживаются в БД? Приведите пример создания индексов.
Индексы не поддерживаются.

### Как строится процесс выполнения запросов в вашей СУБД?
Метрики поступают в стек через службу Carbon, которая записывает данные в Whisper. Пользователи взаимодействуют с веб-интерфейсом Graphite или API, который, в свою очередь, запрашивает у Carbon и Whisper данные, необходимые для построения запрошенных графиков.

Веб-платформа Graphite предлагает множество стилей и форматов вывода, включая необработанные изображения, CSV, XML и JSON, что позволяет любому пользователю легко вставлять пользовательские графики на другие веб-страницы или информационные панели. 

Whisper имеет фиксированный размер и более старые данные хранит в агрегированном виде. Доступные методы агрегирования:
* average
* sum
* last
* max
* min

Каждая метрика представляет собой собственную базу данных, которая представляет собой всего лишь ряд пар время-значение. При считывании метрик, мы применяем к ним функции, которые применяются как раз к этим парам.

### Поддерживаются ли транзакции в вашей СУБД? 
Транзакции не поддерживаются.

### Какие методы восстановления поддерживаются в вашей СУБД? Расскажите о них.
На практике одинаковый поток метрик льют сразу на несколько серверов Graphite с целью создания отказоустойчивости. Если один из серверов падает, то иногда можно успеть поднять упавший сервер достаточно быстро, и залить в него метрики из кэша. Если так сделать не получается,то "дыру" в метриках затягивают rsync`ом. 

### Шардинг

Carbon - это набор демонов: carbon-cache.py, carbon-aggregator.py, carbon-relay.py и carbon_aggregator_cache_plugin.py. 

carbon-cache.py принимает метрики по различным протоколам и записывает их на диск максимально эффективно. 
По мере увеличения количества входящих показателей одного carbon-cache.py может быть недостаточно для обработки ввода-вывода. Чтобы масштабироваться, запускают несколько carbon-cache.py на одной или нескольких машинах, а также запускают carbon-aggregator.py или carbon-relay.py.

### Возможно ли применить термины Data Mining, Data Warehousing и OLAP в вашей СУБД?
Применим OLAP.

### Какие методы защиты поддерживаются вашей СУБД? 
Можно использовать не простой HTTP, а HTTPS.

### Какие сообщества развивают данную СУБД? Кто в проекте имеет права на коммит и создание дистрибутива версий?
Graphite имеет открытый исходный код и поддерживается активным сообществом разработчиков. Сейчас в одном только веб-приложении 1300 форков и 5,5к звёзд. [Саппорт на StackExchage](https://stackexchange.com/filters/27311/graphite).

### Как продолжить самостоятельное изучение языка запросов с помощью демобазы. Если демобазы нет, то создайте ее.
Демобаза доступна в Graphite-Web. В меню слева можно выбрать, за какой метрикой наблюдать:

![Screenshot from 2022-05-05 17-32-53](https://user-images.githubusercontent.com/60742399/166946887-923a65b9-fa0e-404c-ad6d-b9ff3d15a625.png)

![Screenshot from 2022-05-05 17-33-03](https://user-images.githubusercontent.com/60742399/166946865-e0c51798-5b86-4020-9dbb-38aa47fa7df6.png)

Самому можно отправить много метрик через `echo`, передавать различные функции в питоновский код и смотреть, как меняются от этого графики. [Список функций](https://graphite.readthedocs.io/en/latest/functions.html). Например, если мы запустим тот же питоновский код спустя некоторое время, то получим много "пустых" точек. Чтобы отображать последнее ненулевое значение метрики, в параметрах запроса нужно изменить target:`'target':'keepLastValue(foo.bar)'`. Теперь сохраняется только последняя отправленная метрика:

```
[{'target': 'keepLastValue(foo.bar)', 'tags': {'name': 'foo.bar'}, 'datapoints': [[None, 1651761560], [None, 1651761570], [1.0, 1651761580], [1.0, 1651761590]]}]
```

### Где найти документацию и пройти обучение
Документация и Quick Start Guides можно найти на [официальном сайте Graphite](https://graphiteapp.org/).

### Как быть в курсе происходящего

[Сайт](https://graphiteapp.org/). [GitHub](https://github.com/graphite-project).

### Источники
* https://graphiteapp.org/
* https://habr.com/ru/company/tinkoff/blog/252907/
* https://www.oreilly.com/library/view/monitoring-with-graphite/9781491916421/ch01.html
* https://sun.tsu.ru/mminfo/2016/Dombrovski/book/chapter-1/chapter-1-3.htm#02
* https://habr.com/ru/company/avito/blog/343928/
* https://logz.io/blog/prometheus-vs-graphite/
* https://github.com/graphite-project
* https://en.wikipedia.org/wiki/Graphite






